<!--
  ~ Copyright (c) 2015, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.
  ~
  ~ WSO2 Inc. licenses this file to you under the Apache License,
  ~ Version 2.0 (the "License"); you may not use this file except
  ~ in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing,
  ~ software distributed under the License is distributed on an
  ~ "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  ~ KIND, either express or implied.  See the License for the
  ~ specific language governing permissions and limitations
  ~ under the License.
  -->

<bpel:process name="${bpelProcessName}"
         targetNamespace="http://bpel.mgt.workflow.carbon.wso2.org/approvalProcess"
         suppressJoinFailure="yes"
         xmlns:ns1="http://callback.mgt.workflow.identity.carbon.wso2.org"
         xmlns:tns="http://bpel.mgt.workflow.carbon.wso2.org/approvalProcess"
         xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:htw="http://ht.bpel.mgt.workflow.identity.carbon.wso2.org/wsdl"
         xmlns:xsd="http://www.w3.org/2001/XMLSchema"
         xmlns:bsch="http://schema.bpel.mgt.workflow.carbon.wso2.org/"
         xmlns:hsch="http://ht.bpel.mgt.workflow.identity.carbon.wso2.org/wsdl/schema"
         xmlns:b4p="http://docs.oasis-open.org/ns/bpel4people/bpel4people/200803"
         xmlns:ode="http://www.apache.org/ode/type/extension"
         exitOnStandardFault="no" xmlns:cbc="http://callback.mgt.workflow.identity.carbon.wso2.org/xsd" xmlns:htd="http://docs.oasis-open.org/ns/bpel4people/ws-humantask/200803" xmlns:htt="http://docs.oasis-open.org/ns/bpel4people/ws-humantask/types/200803">
    <!-- Import the client WSDL -->
    <bpel:extensions>
        <bpel:extension namespace="http://docs.oasis-open.org/ns/bpel4people/bpel4people/200803" mustUnderstand="yes"></bpel:extension>
    </bpel:extensions>
    
    
    
    
    
    
    <bpel:import namespace="http://ht.bpel.mgt.workflow.identity.carbon.wso2.org/wsdl" location="${htServiceName}Service.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
    
    <bpel:import namespace="http://callback.mgt.workflow.identity.carbon.wso2.org" location="CallbackService.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
    <bpel:import location="${bpelProcessName}.wsdl" namespace="http://bpel.mgt.workflow.carbon.wso2.org/approvalProcess" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />
	
	
	
	<!-- BPEL4People extension activity -->
    <extensions>
        <extension
                namespace="http://docs.oasis-open.org/ns/bpel4people/bpel4people/200803"
                mustUnderstand="yes"/>
    </extensions>
	        
    <!-- ================================================================= -->         
    <!-- PARTNERLINKS                                                      -->
    <!-- List of services participating in this BPEL process               -->
    <!-- ================================================================= -->         
    <bpel:partnerLinks>
        <!--
        The 'client' role represents the requester of this service. It is 
        used for callback. The location and correlation information associated
        with the client role are automatically set using WS-Addressing.
        -->
        <bpel:partnerLink name="client"
                     partnerLinkType="tns:${bpelProcessName}PLT"
                     myRole="partnerRole"
                     />
        <bpel:partnerLink name="callbackService" partnerLinkType="tns:callbackServicePLT"
                          partnerRole="callbackServicePartnerRole"></bpel:partnerLink>
        <bpel:partnerLink name="b4pApprovalPL" partnerLinkType="tns:${htServiceName}PLT" myRole="ApprovalCallbackRole"
                          partnerRole="approvalPartnerRole"></bpel:partnerLink>
    </bpel:partnerLinks>
  
    <!-- ================================================================= -->         
    <!-- VARIABLES                                                         -->
    <!-- List of messages and XML documents used within this BPEL process  -->
    <!-- ================================================================= -->         
    <bpel:variables>
        <!-- Reference to the message passed as input during initiation -->
        <bpel:variable name="input" messageType="tns:${bpelProcessName}RequestMessage"/>
              
              <!-- Variable to hold event type -->
        <bpel:variable name="event" type="xsd:string">
            <bpel:from>
                <bpel:literal>NULL</bpel:literal>
            </bpel:from>
        </bpel:variable>
        
        <bpel:variable name="paramString" type="xsd:string">
            <bpel:from>
                <bpel:literal></bpel:literal>
            </bpel:from>
        </bpel:variable>
        
        <bpel:variable name="approvalInput" messageType="htw:ApprovalRequest">
            <bpel:from>
                <bpel:literal><tns:ApprovalData xmlns:tns="http://ht.bpel.mgt.workflow.identity.carbon.wso2.org/wsdl" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
 					<taskSubject>taskSubject</taskSubject>
  					<taskDescription>taskDescription</taskDescription>
  					<priority>0</priority>
  				<parametersList>
            		<item itemName="name">
               			<itemValue>value</itemValue>
            		</item>
			  	</parametersList>
			</tns:ApprovalData></bpel:literal>
			            </bpel:from>
		</bpel:variable>
        <bpel:variable name="approvalOutput" messageType="htw:ApprovalResponse">
            <bpel:from>
                <bpel:literal><tns:ApprovalCBData xmlns:tns="http://ht.bpel.mgt.workflow.identity.carbon.wso2
                .org/wsdl/schema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  				<approvalStatus>approvalStatus</approvalStatus>
  				<params>params</params>
				</tns:ApprovalCBData>
				</bpel:literal>
            </bpel:from>
        </bpel:variable>
        <bpel:variable name="callBackInput" messageType="ns1:onCallbackRequest">
            <bpel:from>
                <bpel:literal><ns:onCallback xmlns:ns="http://callback.mgt.workflow.identity.carbon.wso2.org/xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <ns:response>
    <!-- <ns:outputParams>
      <ns:name>ns:name</ns:name>
      <ns:value>ns:value</ns:value>
    </ns:outputParams> -->
    <ns:status>ns:status</ns:status>
    <ns:uuid>ns:uuid</ns:uuid>
  </ns:response>
</ns:onCallback>
</bpel:literal>
            </bpel:from>
        </bpel:variable>
        <bpel:variable name="parameterElement" type="hsch:HTParameter">
            <bpel:from>
                <bpel:literal>
                	<tns:item itemName="name" xmlns:tns="http://ht.bpel.mgt.workflow.identity.carbon.wso2.org/wsdl/schema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
               			<tns:itemValue>val</tns:itemValue>
            		</tns:item>
                </bpel:literal>
            </bpel:from>
        </bpel:variable>
        
        
        
        
        <bpel:variable name="list" type="hsch:htParameters"></bpel:variable>
        <bpel:variable name="approvalStatus" type="xsd:string">
            <bpel:from>
                <bpel:literal>true</bpel:literal>
            </bpel:from>
        </bpel:variable>
        <bpel:variable name="stepCount" type="xsd:int">
            <bpel:from>
                <bpel:literal>0</bpel:literal>
            </bpel:from>
        </bpel:variable>
        
        <bpel:variable name="currentStep" type="xsd:int">
            <bpel:from>
                <bpel:literal>0</bpel:literal>
            </bpel:from>
        </bpel:variable>
        
        
        
        
        
        <bpel:variable name="userCount" type="xsd:int"></bpel:variable>
        
        
        
        <bpel:variable name="roleCount" type="xsd:int">
            <bpel:from>
                <bpel:literal>0</bpel:literal>
            </bpel:from>
        </bpel:variable>
        
        
        
        
        <bpel:variable name="userElement" element="htt:user"></bpel:variable>
        
        <bpel:variable name="orgEntity" element="htt:organizationalEntity"></bpel:variable>
        <bpel:variable name="roleElement" element="htt:group"></bpel:variable>
    </bpel:variables>

    <!-- ================================================================= -->         
    <!-- ORCHESTRATION LOGIC                                               -->
    <!-- Set of activities coordinating the flow of messages across the    -->
    <!-- services integrated within this business process                  -->
    <!-- ================================================================= -->         
    <bpel:sequence name="main">
        
        <!-- Receive input from requestor. 
             Note: This maps to operation defined in ${bpelProcessName}.wsdl 
             -->
        <bpel:receive name="receiveInput" partnerLink="client"
                 portType="tns:${bpelProcessName}"
                 operation="initiate" variable="input"
                 createInstance="yes"/>
        
        
        
        <!-- Asynchronous callback to the requester.
             Note: the callback location and correlation id is transparently handled 
             using WS-addressing.
             -->
        
        
        
        <bpel:assign validate="no" name="Init">
            
            <bpel:copy>
                <bpel:from part="payload" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[bsch:eventType]]></bpel:query>
                </bpel:from>
                <bpel:to variable="event"></bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from>
                    <bpel:literal></bpel:literal>
                </bpel:from>
                <bpel:to variable="paramString"></bpel:to>
            </bpel:copy>
            
            <bpel:copy>
                <bpel:from>
                    <bpel:literal><tns:ApprovalData xmlns:p="http://docs.oasis-open.org/ns/bpel4people/ws-humantask/200803" xmlns:tns="http://ht.bpel.mgt.workflow.identity.carbon.wso2.org/wsdl/schema" xmlns:xml="http://www.w3.org/XML/1998/namespace" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <taskSubject>taskSubject</taskSubject>
  <taskDescription>taskDescription</taskDescription>
  <priority>0</priority>
  <parametersList>
    <item itemName="">
      <itemValue>itemValue</itemValue>
    </item>
  </parametersList>
  <assignees>
    <p:leanTask actualOwnerRequired="yes" name="NCName">
      <p:documentation p:lang=""></p:documentation>
      <p:messageSchema>
        <p:documentation p:lang=""></p:documentation>
        <p:messageField name="NCName" type="QName">
          <p:documentation p:lang=""></p:documentation>
          <p:messageDisplay p:lang="">
            <p:documentation p:lang=""></p:documentation>
          </p:messageDisplay>
          <p:messageChoice value="">
            <p:documentation p:lang=""></p:documentation>
            <p:messageDisplay p:lang="">
              <p:documentation p:lang=""></p:documentation>
            </p:messageDisplay>
          </p:messageChoice>
        </p:messageField>
      </p:messageSchema>
      <p:priority expressionLanguage="http://tempuri.org">
        <p:documentation p:lang=""></p:documentation>
      </p:priority>
      <p:peopleAssignments>
        <p:documentation p:lang=""></p:documentation>
        <p:potentialOwners>
          <p:documentation p:lang=""></p:documentation>
          <p:from expressionLanguage="http://tempuri.org" logicalPeopleGroup="NCName">
            <p:documentation p:lang=""></p:documentation>
            <p:argument expressionLanguage="http://tempuri.org" name="NCName">
              <p:documentation p:lang=""></p:documentation>
            </p:argument>
          </p:from>
        </p:potentialOwners>
      </p:peopleAssignments>
      <p:delegation potentialDelegatees="anybody">
        <p:documentation p:lang=""></p:documentation>
        <p:from expressionLanguage="http://tempuri.org" logicalPeopleGroup="NCName">
          <p:documentation p:lang=""></p:documentation>
          <p:argument expressionLanguage="http://tempuri.org" name="NCName">
            <p:documentation p:lang=""></p:documentation>
          </p:argument>
        </p:from>
      </p:delegation>
      <p:presentationElements>
        <p:documentation p:lang=""></p:documentation>
        <p:name p:lang="">
          <p:documentation p:lang=""></p:documentation>
        </p:name>
        <p:presentationParameters expressionLanguage="http://tempuri.org">
          <p:documentation p:lang=""></p:documentation>
          <p:presentationParameter name="NCName" type="QName">
            <p:documentation p:lang=""></p:documentation>
          </p:presentationParameter>
        </p:presentationParameters>
        <p:subject p:lang="">
          <p:documentation p:lang=""></p:documentation>
        </p:subject>
        <p:description contentType="" p:lang="">
          <p:documentation p:lang=""></p:documentation>
        </p:description>
      </p:presentationElements>
      <p:outcome part="" queryLanguage="http://tempuri.org">
        <p:documentation p:lang=""></p:documentation>
      </p:outcome>
      <p:searchBy expressionLanguage="http://tempuri.org" xsi:type="p:tExpression">
        <p:documentation p:lang=""></p:documentation>
      </p:searchBy>
      <p:renderings>
        <p:documentation p:lang=""></p:documentation>
        <p:rendering type="QName">
          <p:documentation p:lang=""></p:documentation>
        </p:rendering>
      </p:renderings>
      <p:deadlines>
        <p:documentation p:lang=""></p:documentation>
        <p:startDeadline name="NCName">
          <p:documentation p:lang=""></p:documentation>
          <p:for expressionLanguage="http://tempuri.org">
            <p:documentation p:lang=""></p:documentation>
          </p:for>
          <p:escalation name="NCName">
            <p:documentation p:lang=""></p:documentation>
            <p:condition expressionLanguage="http://tempuri.org">
              <p:documentation p:lang=""></p:documentation>
            </p:condition>
            <p:toParts>
              <p:documentation p:lang=""></p:documentation>
              <p:toPart expressionLanguage="http://tempuri.org" name="NCName">
                <p:documentation p:lang=""></p:documentation>
              </p:toPart>
            </p:toParts>
            <p:notification name="NCName">
              <p:documentation p:lang=""></p:documentation>
              <p:interface operation="NCName" portType="QName">
                <p:documentation p:lang=""></p:documentation>
              </p:interface>
              <p:priority expressionLanguage="http://tempuri.org">
                <p:documentation p:lang=""></p:documentation>
              </p:priority>
              <p:peopleAssignments>
                <p:documentation p:lang=""></p:documentation>
                <p:potentialOwners>
                  <p:documentation p:lang=""></p:documentation>
                  <p:from expressionLanguage="http://tempuri.org" logicalPeopleGroup="NCName">
                    <p:documentation p:lang=""></p:documentation>
                    <p:argument expressionLanguage="http://tempuri.org" name="NCName">
                      <p:documentation p:lang=""></p:documentation>
                    </p:argument>
                  </p:from>
                </p:potentialOwners>
              </p:peopleAssignments>
              <p:presentationElements>
                <p:documentation p:lang=""></p:documentation>
                <p:name p:lang="">
                  <p:documentation p:lang=""></p:documentation>
                </p:name>
                <p:presentationParameters expressionLanguage="http://tempuri.org">
                  <p:documentation p:lang=""></p:documentation>
                  <p:presentationParameter name="NCName" type="QName">
                    <p:documentation p:lang=""></p:documentation>
                  </p:presentationParameter>
                </p:presentationParameters>
                <p:subject p:lang="">
                  <p:documentation p:lang=""></p:documentation>
                </p:subject>
                <p:description contentType="" p:lang="">
                  <p:documentation p:lang=""></p:documentation>
                </p:description>
              </p:presentationElements>
              <p:renderings>
                <p:documentation p:lang=""></p:documentation>
                <p:rendering type="QName">
                  <p:documentation p:lang=""></p:documentation>
                </p:rendering>
              </p:renderings>
            </p:notification>
          </p:escalation>
        </p:startDeadline>
        <p:completionDeadline name="NCName">
          <p:documentation p:lang=""></p:documentation>
          <p:for expressionLanguage="http://tempuri.org">
            <p:documentation p:lang=""></p:documentation>
          </p:for>
          <p:escalation name="NCName">
            <p:documentation p:lang=""></p:documentation>
            <p:condition expressionLanguage="http://tempuri.org">
              <p:documentation p:lang=""></p:documentation>
            </p:condition>
            <p:toParts>
              <p:documentation p:lang=""></p:documentation>
              <p:toPart expressionLanguage="http://tempuri.org" name="NCName">
                <p:documentation p:lang=""></p:documentation>
              </p:toPart>
            </p:toParts>
            <p:notification name="NCName">
              <p:documentation p:lang=""></p:documentation>
              <p:interface operation="NCName" portType="QName">
                <p:documentation p:lang=""></p:documentation>
              </p:interface>
              <p:priority expressionLanguage="http://tempuri.org">
                <p:documentation p:lang=""></p:documentation>
              </p:priority>
              <p:peopleAssignments>
                <p:documentation p:lang=""></p:documentation>
                <p:potentialOwners>
                  <p:documentation p:lang=""></p:documentation>
                  <p:from expressionLanguage="http://tempuri.org" logicalPeopleGroup="NCName">
                    <p:documentation p:lang=""></p:documentation>
                    <p:argument expressionLanguage="http://tempuri.org" name="NCName">
                      <p:documentation p:lang=""></p:documentation>
                    </p:argument>
                  </p:from>
                </p:potentialOwners>
              </p:peopleAssignments>
              <p:presentationElements>
                <p:documentation p:lang=""></p:documentation>
                <p:name p:lang="">
                  <p:documentation p:lang=""></p:documentation>
                </p:name>
                <p:presentationParameters expressionLanguage="http://tempuri.org">
                  <p:documentation p:lang=""></p:documentation>
                  <p:presentationParameter name="NCName" type="QName">
                    <p:documentation p:lang=""></p:documentation>
                  </p:presentationParameter>
                </p:presentationParameters>
                <p:subject p:lang="">
                  <p:documentation p:lang=""></p:documentation>
                </p:subject>
                <p:description contentType="" p:lang="">
                  <p:documentation p:lang=""></p:documentation>
                </p:description>
              </p:presentationElements>
              <p:renderings>
                <p:documentation p:lang=""></p:documentation>
                <p:rendering type="QName">
                  <p:documentation p:lang=""></p:documentation>
                </p:rendering>
              </p:renderings>
            </p:notification>
          </p:escalation>
        </p:completionDeadline>
      </p:deadlines>
    </p:leanTask>
  </assignees>
</tns:ApprovalData>
</bpel:literal>
                </bpel:from>
                <bpel:to part="ApprovalRequest" variable="approvalInput"></bpel:to>
            </bpel:copy>
            
            <bpel:copy>
                <bpel:from>
                    <bpel:literal><hsch:parametersList xmlns:hsch="http://ht.bpel.mgt.workflow.identity.carbon.wso2.org/wsdl/schema">
            
         </hsch:parametersList></bpel:literal>
                </bpel:from>
                <bpel:to variable="list"></bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from>
                    <bpel:literal><hsch:ApprovalCBData>
         <approvalStatus>UNDEFINED</approvalStatus>
         <params></params>
</hsch:ApprovalCBData></bpel:literal>
                </bpel:from>
                <bpel:to part="ApprovalResponse" variable="approvalOutput"></bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from>
                    <bpel:literal>1</bpel:literal>
                </bpel:from>
                <bpel:to variable="currentStep"></bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
          			<![CDATA[count($input.payload/bsch:configuration/bsch:approvalStep)]]>
                </bpel:from>
                <bpel:to variable="stepCount"></bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from>
                    <bpel:literal>APPROVED</bpel:literal>
                </bpel:from>
                <bpel:to variable="approvalStatus"></bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from>
                    <bpel:literal><p:organizationalEntity xmlns:p="http://docs.oasis-open.org/ns/bpel4people/ws-humantask/types/200803" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  </p:organizationalEntity></bpel:literal>
                </bpel:from>
                <bpel:to variable="orgEntity"></bpel:to>
            </bpel:copy>
        </bpel:assign>
        <bpel:sequence><bpel:forEach parallel="no" counterName="Counter" name="ForEachParam">
            <bpel:startCounterValue>
                <![CDATA[1]]>
            </bpel:startCounterValue>
            <bpel:finalCounterValue>
                <![CDATA[count($input.payload/bsch:parameters/bsch:parameter)]]><!-- count(bsch:parameters/bsch:parameter) -->
				</bpel:finalCounterValue>
				<bpel:scope>
					<bpel:sequence>
						<bpel:forEach parallel="no" counterName="ItemNumber"
							name="ForEachListItem">
							<bpel:startCounterValue
								expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            <![CDATA[1]]>
							</bpel:startCounterValue>
							<bpel:finalCounterValue
								expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[count($input.payload/bsch:parameters/bsch:parameter[round($Counter)]/bsch:value)]]></bpel:finalCounterValue>
							<bpel:scope>
								<bpel:sequence>
									<bpel:if name="If">
										<bpel:condition
											expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$input.payload/bsch:parameters/bsch:parameter[round($Counter)]/bsch:value[round($ItemNumber)]/@itemName]]></bpel:condition>
										<bpel:assign validate="no" name="concatItemName">
											<bpel:copy>
												<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                <![CDATA[concat($paramString,$input.payload/bsch:parameters/bsch:parameter[round($Counter)]/bsch:value[round($ItemNumber)]/@itemName,":")]]>
												</bpel:from>
												<bpel:to variable="paramString"></bpel:to>
											</bpel:copy>
										</bpel:assign>
									</bpel:if>
									<bpel:assign validate="no" name="concatItemValue">
										<bpel:copy>
											<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[concat($paramString,$input.payload/bsch:parameters/bsch:parameter[round($Counter)]/bsch:value[round($ItemNumber)]/bsch:itemValue,",")]]>
											</bpel:from>
											<bpel:to variable="paramString"></bpel:to>
										</bpel:copy>
									</bpel:assign>
								</bpel:sequence>
							</bpel:scope>
						</bpel:forEach>
						<bpel:assign validate="no" name="createElement">
							<bpel:copy>
								<bpel:from>
									<bpel:literal>
										<hsch:item hsch:itemName="undefined"
											xmlns:hsch="http://ht.bpel.mgt.workflow.identity.carbon.wso2.org/wsdl/schema">
											<hsch:itemValue>undefined</hsch:itemValue>

										</hsch:item>
									</bpel:literal>

								</bpel:from>
								<bpel:to variable="parameterElement"></bpel:to>
							</bpel:copy>
							<bpel:copy>
								<bpel:from variable="paramString"></bpel:from>
								<bpel:to variable="parameterElement">
									<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[hsch:itemValue]]></bpel:query>
								</bpel:to>
							</bpel:copy>

							<bpel:copy>
								<bpel:from>
									<bpel:literal></bpel:literal>
								</bpel:from>
								<bpel:to variable="paramString"></bpel:to>
							</bpel:copy>

							<bpel:copy>
								<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[$input.payload/bsch:parameters/bsch:parameter[round($Counter)]/@name]]>
								</bpel:from>
								<bpel:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[$parameterElement/@hsch:itemName]]>
								</bpel:to>
							</bpel:copy>


						</bpel:assign>
						<bpel:assign validate="no" name="populateList">

							<bpel:copy>
								<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0">
                                <![CDATA[ode:insert-as-last-into($list, $parameterElement)]]>
								</bpel:from>
								<bpel:to variable="list">
								</bpel:to>
							</bpel:copy>

						</bpel:assign>
					</bpel:sequence>
				</bpel:scope>
			</bpel:forEach>
			<bpel:assign validate="no" name="InsertToHTInput">
				<bpel:copy>
					<bpel:from>
						<bpel:literal><tns:ApprovalData xmlns:p="http://docs.oasis-open.org/ns/bpel4people/ws-humantask/200803" xmlns:tns="http://ht.bpel.mgt.workflow.identity.carbon.wso2.org/wsdl/schema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <taskSubject>taskSubject</taskSubject>
  <taskDescription>taskDescription</taskDescription>
  <priority>0</priority>
  <htInitiator>htInitiator</htInitiator>
  <parametersList>
    <item itemName="">
      <itemValue>itemValue</itemValue>
    </item>
  </parametersList>
  <assignees>
    <ANY-ELEMENT></ANY-ELEMENT>
  </assignees>
</tns:ApprovalData></bpel:literal>
					</bpel:from>
					<bpel:to variable="approvalInput" part="ApprovalRequest"></bpel:to>
				</bpel:copy>
				<bpel:copy>
					<bpel:from variable="list"></bpel:from>
					<bpel:to part="ApprovalRequest" variable="approvalInput">
						<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            <![CDATA[parametersList]]>
						</bpel:query>
					</bpel:to>
				</bpel:copy>

			</bpel:assign>

		</bpel:sequence>
        <bpel:assign validate="no" name="Assign">
            
            <bpel:copy>
                <bpel:from part="payload" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[bsch:taskInitiator]]></bpel:query>
                </bpel:from>
                <bpel:to part="ApprovalRequest" variable="approvalInput">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[htInitiator]]></bpel:query>
                </bpel:to>
            </bpel:copy>
        </bpel:assign>
        <bpel:while name="WhileStepsExists">
			<bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$approvalStatus='APPROVED' and $stepCount>=$currentStep]]></bpel:condition>
			<bpel:sequence>
				<bpel:assign validate="no" name="AssignListCounts">
					<bpel:copy>
						<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            <![CDATA[count($input.payload/bsch:configuration/bsch:approvalStep[round($currentStep)]/bsch:user)]]>
						</bpel:from>
						<bpel:to variable="userCount"></bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            <![CDATA[count($input.payload/bsch:configuration/bsch:approvalStep[round($currentStep)]/bsch:role)]]>
						</bpel:from>
						<bpel:to variable="roleCount"></bpel:to>
					</bpel:copy>
				</bpel:assign>
				<bpel:forEach parallel="no" counterName="userItem"
					name="ForEachUser">
					<bpel:startCounterValue
						expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[1]]></bpel:startCounterValue>
					<bpel:finalCounterValue
						expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$userCount]]></bpel:finalCounterValue>
					<bpel:scope>
						<bpel:assign validate="no" name="AddToUserList">
							<bpel:copy>
								<bpel:from>
									<bpel:literal>
										<p:user
											xmlns:p="http://docs.oasis-open.org/ns/bpel4people/ws-humantask/types/200803"
											xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">p:user</p:user>
									</bpel:literal>
								</bpel:from>
								<bpel:to variable="userElement"></bpel:to>
							</bpel:copy>
							<bpel:copy>
								<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[$input.payload/bsch:configuration/bsch:approvalStep[round($currentStep)]/bsch:user[round($userItem)]]]>
								</bpel:from>
								<bpel:to variable="userElement"></bpel:to>
							</bpel:copy>
							<bpel:copy>
								<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0">
                                <![CDATA[ode:insert-as-last-into($orgEntity, $userElement)]]>
								</bpel:from>
								<bpel:to variable="orgEntity">
								</bpel:to>
							</bpel:copy>
						</bpel:assign>
					</bpel:scope>
				</bpel:forEach>
				<bpel:forEach parallel="no" counterName="roleItem"
					name="ForEachRole">
					<bpel:startCounterValue
						expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[1]]>
					</bpel:startCounterValue>
					<bpel:finalCounterValue
						expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$roleCount]]></bpel:finalCounterValue>
					<bpel:scope>
						<bpel:assign validate="no" name="AddToRoleList">
							<bpel:copy>
								<bpel:from>
									<bpel:literal>
										<p:group
											xmlns:p="http://docs.oasis-open.org/ns/bpel4people/ws-humantask/types/200803"
											xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">p:group</p:group>
									</bpel:literal>
								</bpel:from>
								<bpel:to variable="roleElement"></bpel:to>
							</bpel:copy>
							<bpel:copy>
								<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[$input.payload/bsch:configuration/bsch:approvalStep[round($currentStep)]/bsch:role[round($roleItem)]]]>
								</bpel:from>
								<bpel:to variable="roleElement"></bpel:to>
							</bpel:copy>
							<bpel:copy>
								<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0">
                                <![CDATA[ode:insert-as-last-into($orgEntity, $roleElement)]]>
								</bpel:from>
								<bpel:to variable="orgEntity">
								</bpel:to>
							</bpel:copy>
						</bpel:assign>
					</bpel:scope>
				</bpel:forEach>
				<bpel:assign validate="no" name="AddToHTInput">
					<bpel:copy>
						<bpel:from variable="orgEntity"></bpel:from>
						<bpel:to part="ApprovalRequest" variable="approvalInput">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[assignees]]></bpel:query>
						</bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            <![CDATA[$input.payload/bsch:configuration/bsch:approvalStep[round($currentStep)]/bsch:humanTask/bsch:humanTaskSubject]]>
						</bpel:from>
						<bpel:to part="ApprovalRequest" variable="approvalInput">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[taskSubject]]></bpel:query>
						</bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            <![CDATA[$input.payload/bsch:configuration/bsch:approvalStep[round($currentStep)]/bsch:humanTask/bsch:humanTaskDescription]]>
						</bpel:from>
						<bpel:to part="ApprovalRequest" variable="approvalInput">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[taskDescription]]></bpel:query>
						</bpel:to>
					</bpel:copy>
				</bpel:assign>
				<bpel:extensionActivity>
					<b4p:peopleActivity name="RemoteTask"
						inputVariable="approvalInput" outputVariable="approvalOutput" isSkipable="yes">
						<b4p:remoteTask partnerLink="b4pApprovalPL"
							operation="approve" responseOperation="approvalResponse"></b4p:remoteTask>
					</b4p:peopleActivity>
				</bpel:extensionActivity>
				<bpel:assign validate="no" name="resetVariables">
					<bpel:copy>
						<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[$currentStep + 1]]>
						</bpel:from>
						<bpel:to variable="currentStep"></bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<p:organizationalEntity
									xmlns:p="http://docs.oasis-open.org/ns/bpel4people/ws-humantask/types/200803"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
								</p:organizationalEntity>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="orgEntity"></bpel:to>
					</bpel:copy>
				</bpel:assign>
				<bpel:assign validate="no" name="AssignApprovalResponse">
					<bpel:copy>
						<bpel:from part="ApprovalResponse" variable="approvalOutput">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[approvalStatus]]></bpel:query>
						</bpel:from>
						<bpel:to variable="approvalStatus"></bpel:to>
					</bpel:copy>
				</bpel:assign>
			</bpel:sequence>
		</bpel:while>
		<bpel:assign validate="no" name="assigncallaBackRequest">
			<bpel:copy>
				<bpel:from>
					<bpel:literal>
						<ns:onCallback
							xmlns:ns="http://callback.mgt.workflow.identity.carbon.wso2.org/xsd"
							xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
							<ns:response>
								<!-- <ns:outputParams> <ns:name>ns:name</ns:name> <ns:value>ns:value</ns:value> 
									</ns:outputParams> -->
								<ns:status>ns:status</ns:status>
								<ns:uuid>ns:uuid</ns:uuid>
							</ns:response>
						</ns:onCallback>
					</bpel:literal>
				</bpel:from>
				<bpel:to variable="callBackInput" part="parameters"></bpel:to>
			</bpel:copy>
			<bpel:copy>
				<bpel:from part="ApprovalResponse" variable="approvalOutput">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[approvalStatus]]></bpel:query>
				</bpel:from>
				<bpel:to part="parameters" variable="callBackInput">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[cbc:response/cbc:status]]></bpel:query>
				</bpel:to>
			</bpel:copy>
			<bpel:copy>
				<bpel:from part="payload" variable="input">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[bsch:uuid]]></bpel:query>
				</bpel:from>
				<bpel:to part="parameters" variable="callBackInput">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[cbc:response/cbc:uuid]]></bpel:query>
				</bpel:to>
			</bpel:copy>
		</bpel:assign>
		<bpel:invoke name="Callaback" partnerLink="callbackService"
			operation="onCallback" portType="ns1:WorkflowCallbackServicePortType"
			inputVariable="callBackInput"></bpel:invoke>
	</bpel:sequence>
</bpel:process>

